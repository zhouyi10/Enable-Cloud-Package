/*!
 * PhotoClip - 一款手势驱动的裁图插件
 * @version v3.4.5
 * @author baijunjie
 * @license MIT
 *
 * git - https://github.com/baijunjie/PhotoClip.js.git
 */
(function webpackUniversalModuleDefinition(root,factory){if(typeof exports==='object'&&typeof module==='object'){module.exports=factory(require("hammerjs"),require("iscroll/build/iscroll-zoom"),require("lrz"))}else if(typeof define==='function'&&define.amd){define(["hammerjs","iscroll","lrz"],factory)}else if(typeof exports==='object'){exports["PhotoClip"]=factory(require("hammerjs"),require("iscroll/build/iscroll-zoom"),require("lrz"))}else{root["PhotoClip"]=factory(root["Hammer"],root["IScroll"],root["lrz"])}})(window,function(__WEBPACK_EXTERNAL_MODULE__5__,__WEBPACK_EXTERNAL_MODULE__6__,__WEBPACK_EXTERNAL_MODULE__7__){return (function(modules){var installedModules={};function __webpack_require__(moduleId){if(installedModules[moduleId]){return installedModules[moduleId].exports;}var module=installedModules[moduleId]={i:moduleId,l:false,exports:{}};modules[moduleId].call(module.exports,module,module.exports,__webpack_require__);module.l=true;return module.exports;}__webpack_require__.m=modules;__webpack_require__.c=installedModules;__webpack_require__.d=function(exports,name,getter){if(!__webpack_require__.o(exports,name)){Object.defineProperty(exports,name,{enumerable:true,get:getter});}};__webpack_require__.r=function(exports){if(typeof Symbol!=='undefined'&&Symbol.toStringTag){Object.defineProperty(exports,Symbol.toStringTag,{value:'Module'});}Object.defineProperty(exports,'__esModule',{value:true});};__webpack_require__.t=function(value,mode){if(mode&1){value=__webpack_require__(value)}if(mode&8){return value}if((mode&4)&&typeof value==='object'&&value&&value.__esModule){return value}var ns=Object.create(null);__webpack_require__.r(ns);Object.defineProperty(ns,'default',{enumerable:true,value:value});if(mode&2&&typeof value!='string'){for(var key in value){__webpack_require__.d(ns,key,function(key){return value[key]}.bind(null,key))}}return ns;};__webpack_require__.n=function(module){var getter=module&&module.__esModule?function getDefault(){return module['default']}:function getModuleExports(){return module};__webpack_require__.d(getter,'a',getter);return getter;};__webpack_require__.o=function(object,property){return Object.prototype.hasOwnProperty.call(object,property)};__webpack_require__.p="";return __webpack_require__(__webpack_require__.s=4);})([(function(module,exports,__webpack_require__){"use strict";module.exports=function(obj){return Object.prototype.toString.call(obj)==='[object Array]'};}),(function(module,exports,__webpack_require__){"use strict";var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};module.exports=function(obj){return(typeof obj==='undefined'?'undefined':_typeof(obj))==='object'};}),(function(module,exports,__webpack_require__){"use strict";module.exports=function(num){return typeof num==='number'};}),(function(module,exports,__webpack_require__){"use strict";var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};var defaultDisplayMap={};module.exports=function(elems,func,target){if((typeof elems==='undefined'?'undefined':_typeof(elems))!=='object'){elems=[]}if(typeof elems.length==='undefined'){elems=[elems]}var hideElems=[],hideElemsDisplay=[];for(var i=0,elem;elem=elems[i++];){while(elem instanceof HTMLElement){var nodeName=elem.nodeName;if(!elem.getClientRects().length){hideElems.push(elem);hideElemsDisplay.push(elem.style.display);var display=defaultDisplayMap[nodeName];if(!display){var temp=document.createElement(nodeName);document.body.appendChild(temp);display=window.getComputedStyle(temp).display;temp.parentNode.removeChild(temp);if(display==='none'){display='block'}defaultDisplayMap[nodeName]=display}elem.style.display=display}if(nodeName==='BODY'){break}elem=elem.parentNode}}if(typeof func==='function'){func.call(target||this)}var l=hideElems.length;while(l--){hideElems.pop().style.display=hideElemsDisplay.pop()}};}),(function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i+=1){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor){descriptor.writable=true}Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps){defineProperties(Constructor.prototype,protoProps)}if(staticProps){defineProperties(Constructor,staticProps)}return Constructor}}();var _hammerjs=__webpack_require__(5);var _hammerjs2=_interopRequireDefault(_hammerjs);var _iscrollZoom=__webpack_require__(6);var _iscrollZoom2=_interopRequireDefault(_iscrollZoom);var _lrz=__webpack_require__(7);var _lrz2=_interopRequireDefault(_lrz);var _bind=__webpack_require__(8);var _bind2=_interopRequireDefault(_bind);var _destroy2=__webpack_require__(9);var _destroy3=_interopRequireDefault(_destroy2);var _extend=__webpack_require__(10);var _extend2=_interopRequireDefault(_extend);var _isNumber=__webpack_require__(2);var _isNumber2=_interopRequireDefault(_isNumber);var _isArray=__webpack_require__(0);var _isArray2=_interopRequireDefault(_isArray);var _isPercent=__webpack_require__(14);var _isPercent2=_interopRequireDefault(_isPercent);var _createElement=__webpack_require__(15);var _createElement2=_interopRequireDefault(_createElement);var _removeElement=__webpack_require__(16);var _removeElement2=_interopRequireDefault(_removeElement);var _hideAction=__webpack_require__(3);var _hideAction2=_interopRequireDefault(_hideAction);var _support=__webpack_require__(17);var _support2=_interopRequireDefault(_support);var _css=__webpack_require__(18);var _css2=_interopRequireDefault(_css);var _attr=__webpack_require__(19);var _attr2=_interopRequireDefault(_attr);var _$=__webpack_require__(20);var _$2=_interopRequireDefault(_$);var _utils=__webpack_require__(22);var utils=_interopRequireWildcard(_utils);function _interopRequireWildcard(obj){if(obj&&obj.__esModule){return obj}else{var newObj={};if(obj!=null){for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key)){newObj[key]=obj[key]}}}newObj.default=obj;return newObj}}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var is_mobile=!!navigator.userAgent.match(/mobile/i),is_android=!!navigator.userAgent.match(/android/i),supportTransition=(0,_support2.default)('transition'),prefix=(0,_support2.default)('transform'),noop=function noop(){};var defaultOptions={size:[100,100],adaptive:'',outputSize:[0,0],outputType:'jpg',outputQuality:.8,maxZoom:1,rotateFree:!is_android,view:'',file:'',ok:'',img:'',loadStart:noop,loadComplete:noop,loadError:noop,done:noop,fail:noop,lrzOption:{width:is_android?1000:undefined,height:is_android?1000:undefined,quality:.7},style:{maskColor:'rgba(0,0,0,.5)',maskBorder:'2px dashed #ddd',jpgFillColor:'#fff'},errorMsg:{noSupport:'您的浏览器版本过于陈旧，无法支持裁图功能，请更换新的浏览器！',imgError:'不支持该图片格式，请选择常规格式的图片文件！',imgHandleError:'图片处理失败！请更换其它图片尝试。',imgLoadError:'图片读取失败！请更换其它图片尝试。',noImg:'没有可裁剪的图片！',clipError:'截图失败！当前图片源文件可能存在跨域问题，请确保图片与应用同源。如果您是在本地环境下执行本程序，请更换至服务器环境。'}};var PhotoClip=function(){function PhotoClip(container,options){_classCallCheck(this,PhotoClip);container=(0,_$2.default)(container);if(container&&container.length){this._$container=container[0]}else{return}this._options=(0,_extend2.default)(true,{},defaultOptions,options);if(prefix===undefined){this._options.errorMsg.noSupport&&alert(this._options.errorMsg.noSupport)}this._init()}_createClass(PhotoClip,[{key:'_init',value:function _init(){var _this=this;var options=this._options;if((0,_isNumber2.default)(options.size)){options.size=[options.size,options.size]}else if((0,_isArray2.default)(options.size)){if(!(0,_isNumber2.default)(options.size[0])||options.size[0]<=0){options.size[0]=defaultOptions.size[0]}if(!(0,_isNumber2.default)(options.size[1])||options.size[1]<=0){options.size[1]=defaultOptions.size[1]}}else{options.size=(0,_extend2.default)({},defaultOptions.size)}if((0,_isNumber2.default)(options.outputSize)){options.outputSize=[options.outputSize,0]}else if((0,_isArray2.default)(options.outputSize)){if(!(0,_isNumber2.default)(options.outputSize[0])||options.outputSize[0]<0){options.outputSize[0]=defaultOptions.outputSize[0]}if(!(0,_isNumber2.default)(options.outputSize[1])||options.outputSize[1]<0){options.outputSize[1]=defaultOptions.outputSize[1]}}else{options.outputSize=(0,_extend2.default)({},defaultOptions.outputSize)}if(options.outputType==='jpg'){options.outputType='image/jpeg'}else{options.outputType='image/png'}if((0,_isArray2.default)(options.adaptive)){this._widthIsPercent=options.adaptive[0]&&(0,_isPercent2.default)(options.adaptive[0])?options.adaptive[0]:false;this._heightIsPercent=options.adaptive[1]&&(0,_isPercent2.default)(options.adaptive[1])?options.adaptive[1]:false}this._outputWidth=options.outputSize[0];this._outputHeight=options.outputSize[1];this._canvas=document.createElement('canvas');this._iScroll=null;this._hammerManager=null;this._clipWidth=0;this._clipHeight=0;this._clipSizeRatio=1;this._$img=null;this._imgLoaded=false;this._containerWidth=0;this._containerHeight=0;this._$clipLayer=null;this._$moveLayer=null;this._$rotationLayer=null;this._viewList=null;this._fileList=null;this._okList=null;this._$mask=null;this._$mask_left=null;this._$mask_right=null;this._$mask_right=null;this._$mask_bottom=null;this._$clip_frame=null;this._atRotation=false;this._rotationLayerWidth=0;this._rotationLayerHeight=0;this._rotationLayerX=0;this._rotationLayerY=0;this._rotationLayerOriginX=0;this._rotationLayerOriginY=0;this._curAngle=0;(0,_bind2.default)(this,'_rotateCW90','_fileOnChangeHandle','_clipImg','_resize','size','load','clear','rotate','scale','clip','destroy');this._initElements();this._initScroll();this._initRotationEvent();this._initFile();this._resize();window.addEventListener('resize',this._resize);if(this._okList=(0,_$2.default)(options.ok)){this._okList.forEach(function($ok){$ok.addEventListener('click',_this._clipImg)})}if(this._options.img){this._lrzHandle(this._options.img)}}},{key:'_initElements',value:function _initElements(){var $container=this._$container,style=$container.style,containerOriginStyle={};containerOriginStyle['user-select']=style['user-select'];containerOriginStyle['overflow']=style['overflow'];containerOriginStyle['position']=style['position'];this._containerOriginStyle=containerOriginStyle;(0,_css2.default)($container,{'user-select':'none','overflow':'hidden'});if((0,_css2.default)($container,'position')==='static'){(0,_css2.default)($container,'position','relative')}this._$clipLayer=(0,_createElement2.default)($container,'photo-clip-layer',{'position':'absolute','left':'50%','top':'50%'});this._$moveLayer=(0,_createElement2.default)(this._$clipLayer,'photo-clip-move-layer');this._$rotationLayer=(0,_createElement2.default)(this._$moveLayer,'photo-clip-rotation-layer');var $mask=this._$mask=(0,_createElement2.default)($container,'photo-clip-mask',{'position':'absolute','left':0,'top':0,'width':'100%','height':'100%','pointer-events':'none'});var options=this._options,maskColor=options.style.maskColor,maskBorder=options.style.maskBorder;this._$mask_left=(0,_createElement2.default)($mask,'photo-clip-mask-left',{'position':'absolute','left':0,'right':'50%','top':'50%','bottom':'50%','width':'auto','background-color':maskColor});this._$mask_right=(0,_createElement2.default)($mask,'photo-clip-mask-right',{'position':'absolute','left':'50%','right':0,'top':'50%','bottom':'50%','background-color':maskColor});this._$mask_top=(0,_createElement2.default)($mask,'photo-clip-mask-top',{'position':'absolute','left':0,'right':0,'top':0,'bottom':'50%','background-color':maskColor});this._$mask_bottom=(0,_createElement2.default)($mask,'photo-clip-mask-bottom',{'position':'absolute','left':0,'right':0,'top':'50%','bottom':0,'background-color':maskColor});this._$clip_frame=(0,_createElement2.default)($mask,'photo-clip-area',{'border':maskBorder,'position':'absolute','left':'50%','top':'50%'});this._viewList=(0,_$2.default)(options.view);if(this._viewList){var viewOriginStyleList=[];this._viewList.forEach(function($view,i){var style=$view.style,viewOriginStyle={};viewOriginStyle['background-repeat']=style['background-repeat'];viewOriginStyle['background-position']=style['background-position'];viewOriginStyle['background-size']=style['background-size'];viewOriginStyleList[i]=viewOriginStyle;(0,_css2.default)($view,{'background-repeat':'no-repeat','background-position':'center','background-size':'contain'})});this._viewOriginStyleList=viewOriginStyleList}}},{key:'_initScroll',value:function _initScroll(){this._iScroll=new _iscrollZoom2.default(this._$clipLayer,{zoom:true,scrollX:true,scrollY:true,freeScroll:true,mouseWheel:true,disablePointer:true,disableTouch:false,disableMouse:false,wheelAction:'zoom',bounceTime:300})}},{key:'_refreshScroll',value:function _refreshScroll(duration){duration=duration||0;var iScrollOptions=this._iScroll.options,maxZoom=this._options.maxZoom,width=this._rotationLayerWidth,height=this._rotationLayerHeight;if(width&&height){iScrollOptions.zoomMin=utils.getScale(this._clipWidth,this._clipHeight,width,height);iScrollOptions.zoomMax=Math.max(maxZoom,iScrollOptions.zoomMin);iScrollOptions.startZoom=Math.min(iScrollOptions.zoomMax,utils.getScale(this._containerWidth,this._containerHeight,width,height))}else{iScrollOptions.zoomMin=1;iScrollOptions.zoomMax=maxZoom;iScrollOptions.startZoom=1}(0,_css2.default)(this._$moveLayer,{'width':width,'height':height});this._$clipLayer.appendChild(this._$moveLayer);this._iScroll.refresh(duration)}},{key:'_resetScroll',value:function _resetScroll(width,height){width=width||0;height=height||0;this._rotationLayerWidth=width;this._rotationLayerHeight=height;this._rotationLayerX=0;this._rotationLayerY=0;this._curAngle=0;setTransform(this._$rotationLayer,this._rotationLayerX,this._rotationLayerY,this._curAngle);(0,_css2.default)(this._$rotationLayer,{'width':width,'height':height});this._refreshScroll();var iScroll=this._iScroll,scale=iScroll.scale,posX=(this._clipWidth-width*scale)*.5,posY=(this._clipHeight-height*scale)*.5;iScroll.scrollTo(posX,posY);iScroll.zoom(iScroll.options.startZoom,undefined,undefined,0)}},{key:'_initRotationEvent',value:function _initRotationEvent(){var _this2=this;if(is_mobile){this._hammerManager=new _hammerjs2.default.Manager(this._$moveLayer);this._hammerManager.add(new _hammerjs2.default.Rotate());var rotateFree=this._options.rotateFree,bounceTime=this._iScroll.options.bounceTime;var startTouch=void 0,startAngle=void 0,curAngle=void 0;this._hammerManager.on('rotatestart',function(e){if(_this2._atRotation){return}startTouch=true;if(rotateFree){startAngle=(e.rotation-_this2._curAngle)%360;_this2._rotationLayerRotateReady(e.center)}else{startAngle=e.rotation}});this._hammerManager.on('rotatemove',function(e){if(!startTouch){return}curAngle=e.rotation-startAngle;rotateFree&&_this2._rotationLayerRotate(curAngle)});this._hammerManager.on('rotateend rotatecancel',function(e){if(!startTouch){return}startTouch=false;if(!rotateFree){curAngle%=360;if(curAngle>180){curAngle-=360}else if(curAngle<-180){curAngle+=360}if(curAngle>30){_this2._rotateBy(90,bounceTime,e.center)}else if(curAngle<-30){_this2._rotateBy(-90,bounceTime,e.center)}return}var angle=curAngle%360;if(angle<0){angle+=360}if(angle<10){curAngle+= -angle}else if(angle>80&&angle<100){curAngle+=90-angle}else if(angle>170&&angle<190){curAngle+=180-angle}else if(angle>260&&angle<280){curAngle+=270-angle}else if(angle>350){curAngle+=360-angle}_this2._rotationLayerRotateFinish(curAngle,bounceTime)})}else{this._$moveLayer.addEventListener('dblclick',this._rotateCW90)}}},{key:'_rotateCW90',value:function _rotateCW90(e){this._rotateBy(90,this._iScroll.options.bounceTime,{x:e.clientX,y:e.clientY})}},{key:'_rotateBy',value:function _rotateBy(angle,duration,center){this._rotateTo(this._curAngle+angle,duration,center)}},{key:'_rotateTo',value:function _rotateTo(angle,duration,center){if(this._atRotation){return}this._rotationLayerRotateReady(center);this._rotationLayerRotateFinish(angle,duration)}},{key:'_rotationLayerRotateReady',value:function _rotationLayerRotateReady(center){var scale=this._iScroll.scale;var coord=void 0;if(!center){coord=utils.loaclToLoacl(this._$rotationLayer,this._$clipLayer,this._clipWidth*.5,this._clipHeight*.5)}else{coord=utils.globalToLoacl(this._$rotationLayer,center.x,center.y)}coord.x/=scale;coord.y/=scale;var coordBy0={x:coord.x-this._rotationLayerX,y:coord.y-this._rotationLayerY};var origin=utils.pointRotate(coordBy0,-this._curAngle);this._rotationLayerOriginX=origin.x;this._rotationLayerOriginY=origin.y;var rect=this._$rotationLayer.getBoundingClientRect();setOrigin(this._$rotationLayer,this._rotationLayerOriginX,this._rotationLayerOriginY);var newRect=this._$rotationLayer.getBoundingClientRect();this._rotationLayerX+=(rect.left-newRect.left)/scale;this._rotationLayerY+=(rect.top-newRect.top)/scale;setTransform(this._$rotationLayer,this._rotationLayerX,this._rotationLayerY,this._curAngle)}},{key:'_rotationLayerRotate',value:function _rotationLayerRotate(angle){setTransform(this._$rotationLayer,this._rotationLayerX,this._rotationLayerY,angle);this._curAngle=angle}},{key:'_rotationLayerRotateFinish',value:function _rotationLayerRotateFinish(angle,duration){var _this3=this;setTransform(this._$rotationLayer,this._rotationLayerX,this._rotationLayerY,angle);var rect=this._$rotationLayer.getBoundingClientRect();setOrigin(this._$rotationLayer,0,0);var rectByOrigin0=this._$rotationLayer.getBoundingClientRect();setTransform(this._$rotationLayer,this._rotationLayerX,this._rotationLayerY,0);var rectByAngle0=this._$rotationLayer.getBoundingClientRect(),moveLayerRect=this._$moveLayer.getBoundingClientRect(),iScroll=this._iScroll,scale=iScroll.scale;var offset={x:rect.left-moveLayerRect.left,y:rect.top-moveLayerRect.top};this._rotationLayerWidth=rect.width/scale;this._rotationLayerHeight=rect.height/scale;this._rotationLayerX=(rectByAngle0.left-rectByOrigin0.left)/scale;this._rotationLayerY=(rectByAngle0.top-rectByOrigin0.top)/scale;iScroll.scrollTo(iScroll.x+offset.x,iScroll.y+offset.y);this._refreshScroll(iScroll.options.bounceTime);var lastScale=Math.max(iScroll.options.zoomMin,Math.min(iScroll.options.zoomMax,scale));if(lastScale!==scale){offset.x=offset.x/scale*lastScale;offset.y=offset.y/scale*lastScale}iScroll.startX+=offset.x;iScroll.startY+=offset.y;if(angle!==this._curAngle&&duration&&(0,_isNumber2.default)(duration)&&supportTransition!==undefined){offset={x:(rectByOrigin0.left-rect.left)/scale,y:(rectByOrigin0.top-rect.top)/scale};setOrigin(this._$rotationLayer,this._rotationLayerOriginX,this._rotationLayerOriginY);setTransform(this._$rotationLayer,this._rotationLayerX+offset.x,this._rotationLayerY+offset.y,this._curAngle);this._atRotation=true;setTransition(this._$rotationLayer,this._rotationLayerX+offset.x,this._rotationLayerY+offset.y,angle,duration,function(){_this3._atRotation=false;_this3._rotateFinishUpdataElem(angle)})}else{this._rotateFinishUpdataElem(angle)}}},{key:'_rotateFinishUpdataElem',value:function _rotateFinishUpdataElem(angle){setOrigin(this._$rotationLayer,this._rotationLayerOriginX=0,this._rotationLayerOriginY=0);setTransform(this._$rotationLayer,this._rotationLayerX,this._rotationLayerY,this._curAngle=angle%360)}},{key:'_initFile',value:function _initFile(){var _this4=this;var options=this._options;if(this._fileList=(0,_$2.default)(options.file)){this._fileList.forEach(function($file){if(!is_mobile){(0,_attr2.default)($file,'accept','image/jpeg, image/x-png, image/png, image/gif')}$file.addEventListener('change',_this4._fileOnChangeHandle)})}}},{key:'_fileOnChangeHandle',value:function _fileOnChangeHandle(e){var files=e.target.files;if(files.length){this._lrzHandle(files[0])}}},{key:'_lrzHandle',value:function _lrzHandle(src){var _this5=this;var options=this._options,errorMsg=options.errorMsg;if((typeof src==='undefined'?'undefined':_typeof(src))==='object'&&src.type&&!/image\/\w+/.test(src.type)){options.loadError.call(this,errorMsg.imgError);return false}this._imgLoaded=false;options.loadStart.call(this,src);try{(0,_lrz2.default)(src,options.lrzOption).then(function(rst){_this5._clearImg();_this5._createImg(rst.base64)}).catch(function(err){options.loadError.call(_this5,errorMsg.imgHandleError,err)})}catch(err){options.loadError.call(this,errorMsg.imgHandleError,err);throw err}}},{key:'_clearImg',value:function _clearImg(){if(!this._$img){return}this._$img.onload=null;this._$img.onerror=null;(0,_removeElement2.default)(this._$img);this._$img=null;this._imgLoaded=false}},{key:'_createImg',value:function _createImg(src){var _this6=this;var options=this._options,errorMsg=options.errorMsg;this._$img=new Image();(0,_css2.default)(this._$img,{'user-select':'none','pointer-events':'none'});this._$img.onload=function(e){var img=e.target;_this6._imgLoaded=true;options.loadComplete.call(_this6,img);_this6._$rotationLayer.appendChild(img);(0,_hideAction2.default)([img,_this6._$moveLayer],function(){_this6._resetScroll(img.naturalWidth,img.naturalHeight)})};this._$img.onerror=function(e){options.loadError.call(_this6,errorMsg.imgLoadError,e)};(0,_attr2.default)(this._$img,'src',src)}},{key:'_clipImg',value:function _clipImg(){var options=this._options,errorMsg=options.errorMsg;if(!this._imgLoaded){options.fail.call(this,errorMsg.noImg);return}var local=utils.loaclToLoacl(this._$rotationLayer,this._$clipLayer),scale=this._iScroll.scale,ctx=this._canvas.getContext('2d');var scaleX=1,scaleY=1;if(this._outputWidth||this._outputHeight){this._canvas.width=this._outputWidth;this._canvas.height=this._outputHeight;scaleX=this._outputWidth/this._clipWidth*scale;scaleY=this._outputHeight/this._clipHeight*scale}else{this._canvas.width=this._clipWidth/scale;this._canvas.height=this._clipHeight/scale}ctx.clearRect(0,0,this._canvas.width,this._canvas.height);ctx.fillStyle=options.style.jpgFillColor;ctx.fillRect(0,0,this._canvas.width,this._canvas.height);ctx.save();ctx.scale(scaleX,scaleY);ctx.translate(this._rotationLayerX-local.x/scale,this._rotationLayerY-local.y/scale);ctx.rotate(this._curAngle*Math.PI/180);ctx.drawImage(this._$img,0,0);ctx.restore();try{var dataURL=this._canvas.toDataURL(options.outputType,options.outputQuality);if(this._viewList){this._viewList.forEach(function($view){(0,_css2.default)($view,'background-image','url('+dataURL+')')})}options.done.call(this,dataURL);return dataURL}catch(err){options.fail.call(this,errorMsg.clipError);throw err}}},{key:'_resize',value:function _resize(width,height){(0,_hideAction2.default)(this._$container,function(){this._containerWidth=this._$container.offsetWidth;this._containerHeight=this._$container.offsetHeight},this);var size=this._options.size,oldClipWidth=this._clipWidth,oldClipHeight=this._clipHeight;if((0,_isNumber2.default)(width)){size[0]=width}if((0,_isNumber2.default)(height)){size[1]=height}if(this._widthIsPercent||this._heightIsPercent){var ratio=size[0]/size[1];if(this._widthIsPercent){this._clipWidth=this._containerWidth/100*parseFloat(this._widthIsPercent);if(!this._heightIsPercent){this._clipHeight=this._clipWidth/ratio}}if(this._heightIsPercent){this._clipHeight=this._containerHeight/100*parseFloat(this._heightIsPercent);if(!this._widthIsPercent){this._clipWidth=this._clipHeight*ratio}}}else{this._clipWidth=size[0];this._clipHeight=size[1]}var clipWidth=this._clipWidth,clipHeight=this._clipHeight;this._clipSizeRatio=clipWidth/clipHeight;if(this._outputWidth&&!this._outputHeight){this._outputHeight=this._outputWidth/this._clipSizeRatio}if(this._outputHeight&&!this._outputWidth){this._outputWidth=this._outputHeight*this._clipSizeRatio}(0,_css2.default)(this._$clipLayer,{'width':clipWidth,'height':clipHeight,'margin-left': -clipWidth/2,'margin-top': -clipHeight/2});(0,_css2.default)(this._$mask_left,{'margin-right':clipWidth/2,'margin-top': -clipHeight/2,'margin-bottom': -clipHeight/2});(0,_css2.default)(this._$mask_right,{'margin-left':clipWidth/2,'margin-top': -clipHeight/2,'margin-bottom': -clipHeight/2});(0,_css2.default)(this._$mask_top,{'margin-bottom':clipHeight/2});(0,_css2.default)(this._$mask_bottom,{'margin-top':clipHeight/2});(0,_css2.default)(this._$clip_frame,{'width':clipWidth,'height':clipHeight});(0,_css2.default)(this._$clip_frame,prefix+'transform','translate(-50%, -50%)');if(clipWidth!==oldClipWidth||clipHeight!==oldClipHeight){this._refreshScroll();var iScroll=this._iScroll,scale=iScroll.scale,offsetX=(clipWidth-oldClipWidth)*.5*scale,offsetY=(clipHeight-oldClipHeight)*.5*scale;iScroll.scrollBy(offsetX,offsetY);var lastScale=Math.max(iScroll.options.zoomMin,Math.min(iScroll.options.zoomMax,scale));if(lastScale!==scale){iScroll.zoom(lastScale,undefined,undefined,0)}}}},{key:'size',value:function size(width,height){this._resize(width,height);return this}},{key:'load',value:function load(src){this._lrzHandle(src);return this}},{key:'clear',value:function clear(){this._clearImg();this._resetScroll();if(this._fileList){this._fileList.forEach(function($file){$file.value=''})}return this}},{key:'rotate',value:function rotate(angle,duration){if(angle===undefined){return this._curAngle}this._rotateTo(angle,duration);return this}},{key:'scale',value:function scale(zoom,duration){if(zoom===undefined){return this._iScroll.scale}this._iScroll.zoom(zoom,undefined,undefined,duration);return this}},{key:'clip',value:function clip(){return this._clipImg()}},{key:'destroy',value:function destroy(){var _this7=this;window.removeEventListener('resize',this._resize);this._$container.removeChild(this._$clipLayer);this._$container.removeChild(this._$mask);(0,_css2.default)(this._$container,this._containerOriginStyle);if(this._iScroll){this._iScroll.destroy()}if(this._hammerManager){this._hammerManager.off('rotatemove');this._hammerManager.off('rotateend');this._hammerManager.destroy()}else{this._$moveLayer.removeEventListener('dblclick',this._rotateCW90)}if(this._$img){this._$img.onload=null;this._$img.onerror=null}if(this._viewList){this._viewList.forEach(function($view,i){(0,_css2.default)($view,_this7._viewOriginStyleList[i])})}if(this._fileList){this._fileList.forEach(function($file){$file.removeEventListener('change',_this7._fileOnChangeHandle);$file.value=null})}if(this._okList){this._okList.forEach(function($ok){$ok.removeEventListener('click',_this7._clipImg)})}(0,_destroy3.default)(this)}}]);return PhotoClip}();exports.default=PhotoClip;;function setOrigin($obj,originX,originY){originX=(originX||0).toFixed(2);originY=(originY||0).toFixed(2);(0,_css2.default)($obj,prefix+'transform-origin',originX+'px '+originY+'px')}function setTransform($obj,x,y,angle){x=x.toFixed(2);y=y.toFixed(2);angle=angle.toFixed(2);(0,_css2.default)($obj,prefix+'transform','translateZ(0) translate('+x+'px,'+y+'px) rotate('+angle+'deg)')}function setTransition($obj,x,y,angle,dur,fn){(0,_css2.default)($obj,prefix+'transform');(0,_css2.default)($obj,prefix+'transition',prefix+'transform '+dur+'ms cubic-bezier(0.1, 0.57, 0.1, 1)');setTransform($obj,x,y,angle);setTimeout(function(){(0,_css2.default)($obj,prefix+'transition','');fn()},dur)}module.exports=exports['default'];}),(function(module,exports){module.exports=__WEBPACK_EXTERNAL_MODULE__5__;}),(function(module,exports){module.exports=__WEBPACK_EXTERNAL_MODULE__6__;}),(function(module,exports){module.exports=__WEBPACK_EXTERNAL_MODULE__7__;}),(function(module,exports,__webpack_require__){"use strict";module.exports=function(context){for(var _len=arguments.length,methods=Array(_len>1?_len-1:0),_key=1;_key<_len;_key+=1){methods[_key-1]=arguments[_key]}methods.forEach(function(method){context[method]=context[method].bind(context)})};}),(function(module,exports,__webpack_require__){"use strict";module.exports=function(context){Object.getOwnPropertyNames(context).forEach(function(prop){delete context[prop]});context.__proto__=Object.prototype};}),(function(module,exports,__webpack_require__){"use strict";var isArray=__webpack_require__(0);var isObject=__webpack_require__(1);var isBoolean=__webpack_require__(11);var isFunction=__webpack_require__(12);var isPlainObject=__webpack_require__(13);module.exports=function extend(){var options=void 0,name=void 0,src=void 0,copy=void 0,copyIsArray=void 0,target=arguments[0]||{},toString=Object.prototype.toString,i=1,length=arguments.length,deep=false;if(isBoolean(target)){deep=target;target=arguments[i]||{};i+=1}if(!isObject(target)&&!isFunction(target)){target={}}if(i===length){target=this;i-=1}for(;i<length;i+=1){if((options=arguments[i])!=null){for(name in options){src=target[name];copy=options[name];if(target===copy){continue}if(deep&&copy&&((copyIsArray=isArray(copy))||isPlainObject(copy))){if(copyIsArray){copyIsArray=false;src=src&&isArray(src)?src:[]}else{src=src&&isPlainObject(src)?src:{}}target[name]=extend(deep,src,copy)}else if(copy!==undefined){target[name]=copy}}}}return target};}),(function(module,exports,__webpack_require__){"use strict";module.exports=function(bool){return typeof bool==='boolean'};}),(function(module,exports,__webpack_require__){"use strict";module.exports=function(func){return typeof func==='function'};}),(function(module,exports,__webpack_require__){"use strict";module.exports=function(obj){return Object.prototype.toString.call(obj)==='[object Object]'};}),(function(module,exports,__webpack_require__){"use strict";module.exports=function(value){return(/%$/.test(value+''))};}),(function(module,exports,__webpack_require__){"use strict";var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};module.exports=function(parentNode,className,id,prop){var elem=document.createElement('DIV');if((typeof className==='undefined'?'undefined':_typeof(className))==='object'){prop=className;className=null}if((typeof id==='undefined'?'undefined':_typeof(id))==='object'){prop=id;id=null}if((typeof prop==='undefined'?'undefined':_typeof(prop))==='object'){for(var p in prop){elem.style[p]=prop[p]}}if(className){elem.className=className}if(id){elem.id=id}parentNode.appendChild(elem);return elem};}),(function(module,exports,__webpack_require__){"use strict";module.exports=function(elem){elem.parentNode&&elem.parentNode.removeChild(elem)};}),(function(module,exports,__webpack_require__){"use strict";module.exports=function(prop,all){var returnProp=all?prop:'';var testElem=document.documentElement;if(prop in testElem.style){return returnProp}var testProp=prop.charAt(0).toUpperCase()+prop.substr(1),prefixs=['Webkit','Moz','ms','O'];for(var i=0,prefix;prefix=prefixs[i++];){if(prefix+testProp in testElem.style){return '-'+prefix.toLowerCase()+'-'+returnProp}}return returnProp};}),(function(module,exports,__webpack_require__){"use strict";var isObject=__webpack_require__(1);var isNumber=__webpack_require__(2);var cssNumber={'animationIterationCount':true,'columnCount':true,'fillOpacity':true,'flexGrow':true,'flexShrink':true,'fontWeight':true,'lineHeight':true,'opacity':true,'order':true,'orphans':true,'widows':true,'zIndex':true,'zoom':true};module.exports=function(elem,prop,value){if(isObject(prop)){for(var p in prop){value=prop[p];if(isNumber(value)&&!cssNumber[prop]){value+='px'}elem.style[p]=value}return elem}if(value===undefined){return window.getComputedStyle(elem)[prop]}else{if(isNumber(value)&&!cssNumber[prop]){value+='px'}elem.style[prop]=value;return elem}};}),(function(module,exports,__webpack_require__){"use strict";var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};module.exports=function(elem,prop,value){if((typeof prop==='undefined'?'undefined':_typeof(prop))==='object'){for(var p in prop){elem[p]=prop[p]}return elem}if(value===undefined){return elem[prop]}else{elem[prop]=value;return elem}};}),(function(module,exports,__webpack_require__){"use strict";var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};var toArray=__webpack_require__(21);module.exports=function(selector,context){if(selector instanceof HTMLElement){return[selector]}else if((typeof selector==='undefined'?'undefined':_typeof(selector))==='object'&&selector.length){return toArray(selector)}else if(!selector||typeof selector!=='string'){return[]}if(typeof context==='string'){context=document.querySelector(context)}if(!(context instanceof HTMLElement)){context=document}return toArray(context.querySelectorAll(selector))};}),(function(module,exports,__webpack_require__){"use strict";module.exports=function(obj){return Array.prototype.map.call(obj,function(n){return n})};}),(function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.getScale=getScale;exports.pointRotate=pointRotate;exports.angleToRadian=angleToRadian;exports.loaclToLoacl=loaclToLoacl;exports.globalToLoacl=globalToLoacl;var _hideAction=__webpack_require__(3);var _hideAction2=_interopRequireDefault(_hideAction);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function getScale(w1,h1,w2,h2){var sx=w1/w2;var sy=h1/h2;return sx>sy?sx:sy}function pointRotate(point,angle){var radian=angleToRadian(angle),sin=Math.sin(radian),cos=Math.cos(radian);return{x:cos*point.x-sin*point.y,y:cos*point.y+sin*point.x}}function angleToRadian(angle){return angle/180*Math.PI}function loaclToLoacl(layerOne,layerTwo,x,y){x=x||0;y=y||0;var layerOneRect=void 0,layerTwoRect=void 0;(0,_hideAction2.default)([layerOne,layerTwo],function(){layerOneRect=layerOne.getBoundingClientRect();layerTwoRect=layerTwo.getBoundingClientRect()});return{x:layerTwoRect.left-layerOneRect.left+x,y:layerTwoRect.top-layerOneRect.top+y}}function globalToLoacl(layer,x,y){x=x||0;y=y||0;var layerRect=void 0;(0,_hideAction2.default)(layer,function(){layerRect=layer.getBoundingClientRect()});return{x:x-layerRect.left,y:y-layerRect.top}}})])});